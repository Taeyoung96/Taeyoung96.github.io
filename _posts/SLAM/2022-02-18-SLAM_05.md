---
title : "Slam 5강 (The Basics about Bundle Adjustment) 요약"
category :
    - Slam
tag :
    - Slam
toc : true
toc_sticky: true
comments: true
---  

Cyrill 교수님의 SLAM 강의를 듣고 정리해보자!  

## 0. Today's Goal  

- Bundle Adjustment란?  
- Bundle Adjustment 과정


## 1. 강의 및 강의 자료  

강의 List는 [SLAM KR](https://www.youtube.com/channel/UCXvT7auo7xUd7v0B2pmvwIA)의 SLAM DUNK seson 2에서 정해준 강의를 따라 정리를 할 것이다.  

SLAM DUNK season 2의 Reference는 [여기](https://youtube.com/playlist?list=PLubUquiqNQdMYwQVftUSFEWhJgzBErO9N)서 확인해 볼 수 있다.  

SLAM KR에서 이 강의를 듣고 요약을 세미나 형식으로 준비를 해준다!  

이번 포스팅은 다음의 강의들을 참고하여 요약을 해보았다.  

- [The Basics about Bundle Adjustment (Cyrill Stachniss)](https://youtu.be/sobyKHwgB0Y)  
- [SLAM DUNK Season 2 - The Basics of Bundle Adjustment](https://youtu.be/sKbNkKwF0cA)  

Cyrill Stachniss의 강의 자료는 pdf로 [다운](https://drive.google.com/file/d/1g5pVXzZMhW5qxvEatd4ROxyMqqK8wKWf/view?usp=sharing) 받을 수 있다.  

## 2. Bundle Adjustment란?   

Bundle Adjustment란 <u>카메라의 이미지 data들로부터 3차원 공간으로 이미지에 나타난 정보들을 모델링을 진행할 때, 카메라의 pose와 3차원 공간의 points들의 위치를 추정할 때 필요한 최적화 기법 중 하나</u>이다.  

Bundle Adjustment를 설명하기 전에 우선 3D Reconstruction이 무엇인지부터 짚고 넘어가보자.  

3D Reconstruction을 진행할 때는 Lidar나 Depth camera같은 거리 값을 이용하는 것이 아니라 2D image들의 묶음(set)으로만 3D 복원을 진행한다.  

보통 SIFT와 같은 특징점을 찾는 알고리즘을 이미지에서 수행하고, Triangulation과 같은 과정을 거쳐 3차원 공간에 point들이 어디 위치하고 있는지 추정을 하게 된다.  

Triangulation의 경우 다른 포스팅에서 조금 더 자세하게 다룰 예정이다.  

예를 들어 한번 3D Reconstruction의 감을 잡아보자.  

<p align="center"><img src="https://user-images.githubusercontent.com/41863759/154620301-b2326c17-1137-4a36-858e-7928395e33bb.png" width = "400" ></p>  

위와 같은 드론으로 아래쪽에 위치한 카메라를 활용하여 3D Reconstruction을 수행하면 결과는 아래와 같다.  

<p align="center"><img src="https://user-images.githubusercontent.com/41863759/154620476-e2e15db1-fdb7-41aa-b4b7-3023d6972dc3.png" width = "500" ></p>  

위 그림에서 파란색 사각형 처럼 보이는 것이 이미지이고 아래쪽에 point cloud 형식으로 시각화된 것이 3차원 output이다. Bundle Adjustment의 결과를 활용하여 위와 같은 예제의 output을 만들 수 있는 것이다.  

강의에서는 3D Reconstruction과 관련된 이야기를 계속 하는데, 그렇다면 두 장의 이미지가 아닌 더 많은 이미지 set이 필요한 이유는 무엇일까?  

왜냐하면 물체를 3차원으로 표현할 때 2장의 이미지로는 물체의 복잡한 표면을 모두 담아낼 수 없기 때문이다. 따라서 조금 더 많은 이미지들을 활용하여 추정한 결과(camera pose or 3D location points)를 조금 더 정교하게 최적화하는 과정이 필수적으로 필요하다.  

최적화 과정(Bundle Adjustment)을 수행하면 아래와 같이 대규모의 Map을 만드는 것도 가능하다.  

<p align="center"><img src="https://user-images.githubusercontent.com/41863759/154623011-6d9b0b80-1ee1-4b53-b381-d337d6c5e573.png" width = "500" ></p>  

Bundle Adjustment는 Bundle Block Adjustment라고도 부르는데, Bundle Adjustment 과정을 Block 단위로 수행하여 많은 이미지 쌍을 동시에 고려를 해서 최적화를 수행하기 때문이다.  

Bundle Adjustment라는 개념은 1950년대 photogrammetry분야의 Aerial Triangulation라는 분야에서 처음 나왔다.  

<p align="center"><img src="https://user-images.githubusercontent.com/41863759/154623695-ec1b596e-e930-4db7-bb59-d3bd0ae011a6.png" width = "500" ></p>  

초창기에는 몇몇 3차원 point들이 어디있는지 안다는 가정하에 camera pose를 추정하였는데 이러한 point들을 control point라고 부른다.  


대략적인 Bundle Adjustment 개념부터 간략하게 Bundle Adjustment의 역사까지 훑아보았다. 그럼 어떻게 Bundle Adjustment가 동작하는지 알아보자.  

## 3. Bundle Adjustment 과정  

앞서 설명했지만, Bundle Adjustment과정은 여러 이미지 정보를 활용하여 camera pose와 3D points를 추정하는데 사용하는 최적화 방법이다.  

우선 Bundle Adjustment을 수행하기 위해선 이미지에서 특징점을 추출해야 한다. 어떤 특징점 알고리즘을 사용하는지는 상관이 없다. SIFT,SURF,ORB 등등 다양한 알고리즘을 사용해도 된다. 그리고 뽑힌 특징점만을 3D Reconstruction에 이용을 한다.  

Camera pose 추정과 3D point location 추정을 동시에 진행하고  최적화를 진행할 때 정의하는 Error를 Non-linear squares 방법을 활용해서 해결한다. 

Non-linear squares 방법을 사용하기 때문에 초기값(Initial guess)이 존재해야 한다. 초기값으로 6-DOF camera pose와 3D points를 정의한다음, 3D points를 정의한 camera pose에 투영하는 과정을 거친다.  

3D points들을 이미지로 투영을 시키게 된다면, 이미지상에 투영된 점들이 어느 위치에 있는지 계산을 할 수 있다. 계산된 값과 실제로 Measurement(특징점 알고리즘을 사용하여 측정된 points들)들을 활용해서 얼마나 차이가 있는지 계산을 할 수 있다.  

이런 오차를 줄여 나아가는 것이 Bundle Adjustment과정이다. 이렇게 만든 오차를 Reprojection error라고 한다.    

만약 오차가 없다면 가정한 Camera pose와 3D points location이 잘 추정된 것이라고 생각할 수 있다.  

---

지금까지 설명한 **Bundle Adjustment 방법을 정리**하면 아래와 같다.  

1. 이미지에서 특징점을 추출한다. 3차원 공간에 특징점들의 실제 위치를 추정하는 것을 목표로 한다.    
2. 6-DOF camera pose와 3D points들의 위치의 초기값을 정한다.  
3. 3D points들을 가정한 camera pose에 투영(projection)을 시킨다.  
4. 이미지에 투영된 점들의 위치와 실제 Measurement(특징점을 추출)들의 위치를 활용해서 Reprojection error를 정의한다.  
5. Reprojection error를 줄이기 위해 Non-linear squares 방법을 사용한다.  

### Reprojection error  

수식적으로 지금까지 이야기한 내용을 알아보면 아래와 같다.  

<p align="center"><img src="https://user-images.githubusercontent.com/41863759/154641609-0d36b914-8e5b-4db6-9501-e1b175db4126.png" width = "600" ></p>  

수식에 Notation이 많아 어질어질하지만 차근차근 살펴보자.  

이 수식은 결국 3D point $\hat{X_i}$을 projection matrix $\hat{P_j}$ 및 scale factor $\hat{\lambda_{ij}}$를 활용해서  
이미지에 투영시키고, 실제 이미지에서 뽑아낸 특징점 $x'_{ij}$  

그리고 픽셀 단위에서 오차값 $\hat{v_{x'_{ij}}}$을 활용해서 식을 정의했다.  
$i$는 3D points 중에서 $i$번째 point를 의미하고, $j$는 $j$번째 이미지의 ID를 의미한다.  

